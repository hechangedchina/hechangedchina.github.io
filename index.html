<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>他</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="他">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="他">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="他">
  
    <link rel="alternate" href="/atom.xml" title="他" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">他</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Android应用的增量更新" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/27/Android应用的增量更新/" class="article-date">
  <time datetime="2017-03-27T06:12:24.000Z" itemprop="datePublished">2017-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/27/Android应用的增量更新/">Android应用的增量更新</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>Android应用更新版本时需要下载apk文件进行安装，而现在的apk都比较大，一次下载一个完整的apk包太冤枉。因此增量更新应运而生。</p>
<p><strong><strong>原理很简单</strong></strong>：通过linux工具bsdiff计算新老apk文件的差异，将差异记录为一个体积较小的patch包。通过bspatch工具（和bsdiff配套的）将老apk文件与这个patch包合并为新apk文件并安装，达到增量更新的目的。  </p>
<p><strong><strong>由此可得方案</strong></strong>：应用在做版本更新操作时获取到了版本号有更新，就将本地的老apk包的MD5校验值与版本号提交给服务器。服务器检验md5和版本号后，把使用bsdiff生成的patch包下载地址与最新版本apk的MD5校验值传回给应用。<br>手机端应用程序下载到patch后，使用<strong><em>内置的bspatch工具</em></strong>将自己本地旧的apk文件与patch包合并为新版本apk文件，计算校验值正确便开始安装。整个流程若校验值错误，则下载全量包安装。</p>
<h2 id="目标：-编写一个demo，实现通过读取磁盘上的patch文件实现自我更新。"><a href="#目标：-编写一个demo，实现通过读取磁盘上的patch文件实现自我更新。" class="headerlink" title="目标： 编写一个demo，实现通过读取磁盘上的patch文件实现自我更新。"></a>目标： 编写一个demo，实现通过读取磁盘上的patch文件实现自我更新。</h2><ol>
<li><p>首先实验一下bsdiff/bspatch工具是否能够正常工作，达到预期效果。  </p>
<p>本人在Win10使用了Linux子系统功能，自带了一个Ubuntu14.04，直接用命令安装bsdiff。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">➜  ~ sudo apt-get install bsdiff</div><div class="line">[sudo] password <span class="keyword">for</span> administrator:</div><div class="line">Reading package lists... Done</div><div class="line">Building dependency tree</div><div class="line">Reading state information... Done</div><div class="line">The following NEW packages will be installed:</div><div class="line">  bsdiff</div><div class="line">0 upgraded, 1 newly installed, 0 to remove and 98 not upgraded.</div><div class="line">Need to get 14.5 kB of archives.</div><div class="line">After this operation, 69.6 kB of additional disk space will be used.</div><div class="line">Get:1 http://archive.ubuntu.com/ubuntu/ trusty/universe bsdiff amd64 4.3-15 [14.                                                                                                                                                             5 kB]</div><div class="line">Fetched 14.5 kB <span class="keyword">in</span> 10s (1,335 B/s)</div><div class="line">Selecting previously unselected package bsdiff.</div><div class="line">(Reading database ... 33465 files and directories currently installed.)</div><div class="line">Preparing to unpack .../bsdiff_4.3-15_amd64.deb ...</div><div class="line">Unpacking bsdiff (4.3-15) ...</div><div class="line">Processing triggers <span class="keyword">for</span> man-db (2.6.7.1-1ubuntu1) ...</div><div class="line">Setting up bsdiff (4.3-15) ...</div><div class="line">➜  ~ bsdiff</div><div class="line">bsdiff: usage: bsdiff oldfile newfile patchfile</div><div class="line">➜  ~ bspatch</div><div class="line">bspatch: usage: bspatch oldfile newfile patchfile</div></pre></td></tr></table></figure>
<p>我们可以看到bsdiff/bspatch都正常安装了。</p>
<p>接下来，这边生成了两个Android apk，old.apk和new.apk。new.apk相对old.apk修改了一点代码。<br>我们这里把它们的md5都算出来。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">➜  app git:(master) ✗ ll *.apk</div><div class="line">-rwxrwxrwx 1 root root 22M Mar 27 09:56 new.apk</div><div class="line">-rwxrwxrwx 1 root root 22M Mar 27 09:32 old.apk</div><div class="line">➜  app git:(master) ✗ md5sum old.apk</div><div class="line">045382b701ce372aecd5bb87ee1e526d  old.apk</div><div class="line">➜  app git:(master) ✗ md5sum new.apk</div><div class="line">cbb1afdbc32e4d1c62c4d38674a6a3a9  new.apk</div></pre></td></tr></table></figure>
<p>然后用bisdiff 通过old/new.apk文件 打出一个patch</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">➜  app git:(master) ✗ bsdiff old.apk new.apk patch</div><div class="line">➜  app git:(master) ✗ ll patch</div><div class="line">-rwxrwxrwx 1 root root 3.5M Mar 27 13:52 patch</div></pre></td></tr></table></figure>
<p>打patch包过程时间稍微有点长，十几秒左右。可以看到打出来的patch包只有3.5M。</p>
<p>接下来实验一下将old.apk与patch包合并，能否得到刚才的new.apk</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">➜  app git:(master) ✗ bspatch old.apk out.apk patch</div><div class="line">➜  app git:(master) ✗ md5sum out.apk</div><div class="line">cbb1afdbc32e4d1c62c4d38674a6a3a9  out.apk</div></pre></td></tr></table></figure>
<p>可以看到这里out.apk的MD5校验值和之前的new.apk是一样的。这个工具通过了实验，若能将它应用到项目，每次只用下载很少的数据就能完成版本更新。</p>
</li>
<li><p>如何将它应用到项目呢？按照刚才的实验，可以发现合包需要bspatch工具。我们需要做的是将bspatch加入到Android代码中。</p>
<p>一个显而易见的方案就是将bspatch的源码（地址：<a href="http://www.daemonology.net/bsdiff/" target="_blank" rel="external">bsdiff</a>）使用ndk编译为so文件，通过jni调用。这样有点麻烦，不过我们可以方便一点：<br>有个叫SmartAppUpdate（<a href="https://github.com/cundong/SmartAppUpdates" target="_blank" rel="external">Github: SmartAppUpdate</a>）的项目，它已经把bspatch的源码加入到jni内了。只要下载它并编译，就可以在应用内嵌入bspatch，实现增量更新了。</p>
<p>配置好NDK，在SmartAppUpdates的目录内执行ndk-build：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">\ApkPatchLibrary\app\src\main\jni&gt;ndk-build</div><div class="line">[arm64-v8a] Compile        : ApkPatchLibrary &lt;= com_cundong_utils_PatchUtils.c</div><div class="line">[arm64-v8a] SharedLibrary  : libApkPatchLibrary.so</div><div class="line">[arm64-v8a] Install        : libApkPatchLibrary.so =&gt; libs/arm64-v8a/libApkPatchLibrary.so</div><div class="line">[x86_64] Compile        : ApkPatchLibrary &lt;= com_cundong_utils_PatchUtils.c</div><div class="line">[x86_64] SharedLibrary  : libApkPatchLibrary.so</div><div class="line">[x86_64] Install        : libApkPatchLibrary.so =&gt; libs/x86_64/libApkPatchLibrary.so</div><div class="line">[mips64] Compile        : ApkPatchLibrary &lt;= com_cundong_utils_PatchUtils.c</div><div class="line">[mips64] SharedLibrary  : libApkPatchLibrary.so</div><div class="line">[mips64] Install        : libApkPatchLibrary.so =&gt; libs/mips64/libApkPatchLibrary.so</div><div class="line">[armeabi-v7a] Compile thumb  : ApkPatchLibrary &lt;= com_cundong_utils_PatchUtils.c</div><div class="line">[armeabi-v7a] SharedLibrary  : libApkPatchLibrary.so</div><div class="line">[armeabi-v7a] Install        : libApkPatchLibrary.so =&gt; libs/armeabi-v7a/libApkPatchLibrary.so</div><div class="line">[armeabi] Compile thumb  : ApkPatchLibrary &lt;= com_cundong_utils_PatchUtils.c</div><div class="line">[armeabi] SharedLibrary  : libApkPatchLibrary.so</div><div class="line">[armeabi] Install        : libApkPatchLibrary.so =&gt; libs/armeabi/libApkPatchLibrary.so</div><div class="line">[x86] Compile        : ApkPatchLibrary &lt;= com_cundong_utils_PatchUtils.c</div><div class="line">[x86] SharedLibrary  : libApkPatchLibrary.so</div><div class="line">[x86] Install        : libApkPatchLibrary.so =&gt; libs/x86/libApkPatchLibrary.so</div><div class="line">[mips] Compile        : ApkPatchLibrary &lt;= com_cundong_utils_PatchUtils.c</div><div class="line">[mips] SharedLibrary  : libApkPatchLibrary.so</div><div class="line">[mips] Install        : libApkPatchLibrary.so =&gt; libs/mips/libApkPatchLibrary.so</div><div class="line"></div><div class="line">\ApkPatchLibrary\app\src\main\jni&gt;</div></pre></td></tr></table></figure>
<p>到这一步，我们可以得到名为libApkPatchLibrary.so的库，通过com.cundong.utils.PatchUtils模块来调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PatchUtils</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * native方法 使用路径为oldApkPath的apk与路径为patchPath的补丁包，合成新的apk，并存储于newApkPath</div><div class="line">	 * </div><div class="line">	 * 返回：0，说明操作成功</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> oldApkPath 示例:/sdcard/old.apk</div><div class="line">	 * <span class="doctag">@param</span> newApkPath 示例:/sdcard/new.apk</div><div class="line">	 * <span class="doctag">@param</span> patchPath  示例:/sdcard/xx.patch</div><div class="line">	 * <span class="doctag">@return</span></div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">patch</span><span class="params">(String oldApkPath, String newApkPath,</span></span></div><div class="line">			String patchPath);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>被调用的相应jni代码为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * Class:     com_cundong_utils_PatchUtils</div><div class="line"> * Method:    patch</div><div class="line"> * Signature: (Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;)I</div><div class="line"> */</div><div class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">Java_com_cundong_utils_PatchUtils_patch</span><span class="params">(JNIEnv *env,</span></span></div><div class="line">		jobject obj, jstring old, jstring <span class="keyword">new</span>, jstring patch) &#123;</div><div class="line"></div><div class="line">	<span class="keyword">char</span> * ch[<span class="number">4</span>];</div><div class="line">	ch[<span class="number">0</span>] = <span class="string">"bspatch"</span>;</div><div class="line">	ch[<span class="number">1</span>] = (<span class="keyword">char</span>*) ((*env)-&gt;GetStringUTFChars(env, old, <span class="number">0</span>));</div><div class="line">	ch[<span class="number">2</span>] = (<span class="keyword">char</span>*) ((*env)-&gt;GetStringUTFChars(env, <span class="keyword">new</span>, <span class="number">0</span>));</div><div class="line">	ch[<span class="number">3</span>] = (<span class="keyword">char</span>*) ((*env)-&gt;GetStringUTFChars(env, patch, <span class="number">0</span>));</div><div class="line"></div><div class="line">	__android_log_print(ANDROID_LOG_INFO, <span class="string">"ApkPatchLibrary"</span>, <span class="string">"old = %s "</span>, ch[<span class="number">1</span>]);</div><div class="line">	__android_log_print(ANDROID_LOG_INFO, <span class="string">"ApkPatchLibrary"</span>, <span class="string">"new = %s "</span>, ch[<span class="number">2</span>]);</div><div class="line">	__android_log_print(ANDROID_LOG_INFO, <span class="string">"ApkPatchLibrary"</span>, <span class="string">"patch = %s "</span>, ch[<span class="number">3</span>]);</div><div class="line"></div><div class="line">	<span class="keyword">int</span> ret = applypatch(<span class="number">4</span>, ch);</div><div class="line"></div><div class="line">	__android_log_print(ANDROID_LOG_INFO, <span class="string">"ApkPatchLibrary"</span>, <span class="string">"applypatch result = %d "</span>, ret);</div><div class="line"></div><div class="line">	(*env)-&gt;ReleaseStringUTFChars(env, old, ch[<span class="number">1</span>]);</div><div class="line">	(*env)-&gt;ReleaseStringUTFChars(env, <span class="keyword">new</span>, ch[<span class="number">2</span>]);</div><div class="line">	(*env)-&gt;ReleaseStringUTFChars(env, patch, ch[<span class="number">3</span>]);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其实applypatch函数就是bspatch代码的main函数，它这里改了个名字。</p>
<p>现在，我们在SmartAppUpdates的Demo项目中测试加入App中的bspatch代码是否能够正常工作：<br>把刚才的old.apk和patch包拷贝到手机的/sdcard/目录，并将如下代码加到App的onCreate()方法内。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">PatchUtils.patch(Environment.getExternalStorageDirectory().getPath() + <span class="string">"/old.apk"</span>,</div><div class="line">        Environment.getExternalStorageDirectory().getPath() + <span class="string">"/out.apk"</span>,</div><div class="line">        Environment.getExternalStorageDirectory().getPath() + <span class="string">"/patch"</span>);</div></pre></td></tr></table></figure>
<p>运行APP后，按照预期/sdcard/目录会生成out.apk。通过adb shell在手机内执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/sdcard $ md5sum out.apk</div><div class="line">cbb1afdbc32e4d1c62c4d38674a6a3a9  out.apk</div></pre></td></tr></table></figure>
<p>这里可以看到在app程序内嵌入的bspatch也成功的通过了老apk和patch包生成了新的apk，生成的out.apk的MD5值与new.apk是一致的。测试通过。</p>
</li>
<li><p>自我更新<br>新建一个Android项目，名字叫PatchDemo。它可以通过patch包实现自我更新。代码为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        Button button = (Button) findViewById(R.id.button);</div><div class="line">        button.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                patch();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">patch</span><span class="params">()</span> </span>&#123;</div><div class="line">        String outPath = Environment.getExternalStorageDirectory().getPath() + <span class="string">"/new.apk"</span>;</div><div class="line">        <span class="keyword">if</span> (PatchUtils.patch(<span class="keyword">this</span>, Environment.getExternalStorageDirectory().getPath() + <span class="string">"/update.patch"</span>, outPath)) &#123;</div><div class="line">            Toast.makeText(<span class="keyword">this</span>, <span class="string">"updating !"</span>, Toast.LENGTH_LONG).show();</div><div class="line">            startActivity(<span class="keyword">new</span> Intent(Intent.ACTION_VIEW).setDataAndType(Uri.fromFile(<span class="keyword">new</span> File(outPath)),</div><div class="line">                    <span class="string">"application/vnd.android.package-archive"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            Toast.makeText(<span class="keyword">this</span>, <span class="string">"cannot update"</span>, Toast.LENGTH_LONG).show();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>PatchUtils代码改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PatchUtils</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        System.loadLibrary(<span class="string">"ApkPatchLibrary"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * native方法 使用路径为oldApkPath的apk与路径为patchPath的补丁包，合成新的apk，并存储于newApkPath</div><div class="line">     * &lt;p&gt;</div><div class="line">     * 返回：0，说明操作成功</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> oldApkPath 示例:/sdcard/old.apk</div><div class="line">     * <span class="doctag">@param</span> newApkPath 示例:/sdcard/new.apk</div><div class="line">     * <span class="doctag">@param</span> patchPath  示例:/sdcard/xx.patch</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">patch</span><span class="params">(String oldApkPath, String newApkPath,</span></span></div><div class="line">                                   String patchPath);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 从patch更新自身，生成到newApkPath</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> context</div><div class="line">     * <span class="doctag">@param</span> patchPath</div><div class="line">     * <span class="doctag">@return</span> 成功返回true</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">patch</span><span class="params">(Context context, String patchPath, String newApkPath)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span> == patch(context.getPackageResourcePath(), newApkPath, patchPath) &amp;&amp; <span class="keyword">new</span> File(newApkPath).exists();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在layout上放一个按钮，点击按钮会调用patch过程。从/sdcard/update.patch路径读取patch包，生成new.apk，然后调用安装。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"</div><div class="line">    xmlns:app="http://schemas.android.com/apk/res-auto"</div><div class="line">    xmlns:tools="http://schemas.android.com/tools"</div><div class="line">    android:layout_width="match_parent"</div><div class="line">    android:layout_height="match_parent"</div><div class="line">    tools:context="com.example.administrator.patchdemo.MainActivity"&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id="@+id/button"</div><div class="line">        android:layout_width="wrap_content"</div><div class="line">        android:layout_height="wrap_content"</div><div class="line">        android:layout_centerInParent="true"</div><div class="line">        android:text="Button" /&gt;</div><div class="line">&lt;/RelativeLayout&gt;</div></pre></td></tr></table></figure>
<p>编译生成app-debug-old.apk，然后修改 android:text=”Button” 为 android:text=”NEW Button”， 再次编译生成 app-debug-new.apk。</p>
<p>使用 bsdiff 生成patch包，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">➜  bsdiff app-debug-old.apk app-debug-<span class="keyword">new</span>.apk update.patch</div></pre></td></tr></table></figure>
<p>将update.patch放到/sdcard路径，安装app-debug-old.apk，运行APP，点击button按钮。若一切正常，会弹出APP安装界面，安装后运行APP发现Button按钮的标题已经从Button修改成NEW Button了。</p>
</li>
<li><p><strong><strong>这样就结束了吗？Naive!</strong></strong></p>
<p>你可以尝试不放入update.patch文件，会发现点击button的时候应用直接没了。因为bspatch工具是个命令行工具，它对文件未找到的异常的处理就是直接exit()把进程终结。 更新个增量包，自己先退出了，这样搞肯定是不行的，所以还需要把SmartAppUpdates项目的c代码中bspatch乱结束进程的代码给改了。至于怎么改代码就见仁见智了。</p>
</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p> 增量更新这个东西原理很简单，效果也很不错，节省流量也十分方便，而且部署到项目内也不困难，只是需要用户手动点击安装（非Root），做好足够的测试就可以在项目中运用它了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/27/Android应用的增量更新/" data-id="cj0rqksw80000rk3wcdla5rmv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/增量更新/">增量更新</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/27/hello-world/" class="article-date">
  <time datetime="2017-03-27T05:51:49.605Z" itemprop="datePublished">2017-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/27/hello-world/">Hexo 使用说明</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/27/hello-world/" data-id="cj0rqksxk000nrk3wcy0dckq6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Android热修复框架-AndFix在项目内部署" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/26/Android热修复框架-AndFix在项目内部署/" class="article-date">
  <time datetime="2017-03-26T10:42:43.000Z" itemprop="datePublished">2017-03-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/26/Android热修复框架-AndFix在项目内部署/">Android热修复框架: AndFix在项目内部署</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p><strong>AndFix</strong> <a href="https://github.com/alibaba/AndFix.git" target="_blank" rel="external">Github: AndFix</a>（当前版本0.5.0）是一个通过Native层替换Java类函数指针，达到修改程序流程，实现热修复的框架。<br>App使用该框架可以达到无声修复bug代码内bug的效果，用户不需要重新安装app。<br>AndFix经测试可以在开启MultiDex的项目内使用，但仅能新增/修改Java内的方法，新增类/修改类属性不会产生修改，可以说局限性还是比较大。在项目中应用AndFix需要谨慎使用，多测试，因为一不小心App就可能会Crash。</p>
<h2 id="目标：-将AndFix框架部署到Android项目中。本文会带你处理遇到的坑。"><a href="#目标：-将AndFix框架部署到Android项目中。本文会带你处理遇到的坑。" class="headerlink" title="目标： 将AndFix框架部署到Android项目中。本文会带你处理遇到的坑。"></a>目标： 将AndFix框架部署到Android项目中。本文会带你处理遇到的坑。</h2><p>本文使用Android Studio，非Android Studio项目请自行解决。</p>
<ol>
<li><p>在build.gradle内添加 </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">dependencies</span>&#123;</div><div class="line">	<span class="keyword">compile</span> <span class="string">'com.alipay.euler:andfix:0.5.0@aar'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>这时候会遇到一个问题：如果你运行了APP，可能发现代码执行System.loadLibrary()时，会报so库找不到（如果你的项目中没有包含所有平台的so库），异常名字叫 java.lang.UnsatisfiedLinkError。此时需要在build.gradle 内添加ndk声明，指定你的项目只支持哪些平台的so库。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">    defaultConfig &#123;</div><div class="line">        ndk &#123;</div><div class="line">            <span class="comment">// 设置支持的 SO 库构架</span></div><div class="line">            abiFilters <span class="string">'armeabi'</span>, <span class="string">'armeabi-v7a'</span><span class="comment">//, 'arm64-v8a', 'x86', 'x86_64', 'mips', 'mips64'</span></div><div class="line">        &#125;</div><div class="line">......</div></pre></td></tr></table></figure>
<p>现在Gradle Sync一下，完成后就成功引入了andFix。</p>
</li>
<li><p>添加一个简单的热修复工具类作为尝试。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PatchHelper</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> PatchManager sPatchManager;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">PatchHelper</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context applicationContext, String appVersion)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != sPatchManager) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"already inited"</span>);</div><div class="line">        &#125;</div><div class="line">        sPatchManager = <span class="keyword">new</span> PatchManager(applicationContext);</div><div class="line">        sPatchManager.init(appVersion);</div><div class="line">        sPatchManager.loadPatch();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">addPatch</span><span class="params">(String patchPath)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == sPatchManager) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"need init"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            sPatchManager.addPatch(patchPath);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你需要在Application初始化的时候，也就是onCreate()里，执行一下PatchHelper.init(getApplicationContext());<br>需要动态修复的时候，将apatch文件下载到手机存储内，执行PatchHelper.addPatch(apatch文件路径)即可完成修复。  </p>
<p><strong><em>本文不会讲解如何使用apkpatch工具生成apatch文件并传给app的过程。请自行解决。</em></strong>   </p>
<p>自己在一个Android项目中做了一些热修复实验，在实验过程中发现一些问题：</p>
<p>1) 无法修改Activity中的方法，会报出错误。说是调用父类方法出java.lang.NoSuchMethodException了。<br>2) 无法修改带有System.loadLibrary(）调用的方法，会抛出java.lang.UnsatisfiedLinkError。较莫名其妙。</p>
<p>最后自己尝试修改了一个简单类的方法行为（里面基本没啥东西，也没有继承自某个父类），成功了。</p>
<p><strong><em>个人感觉目前这个热修复框架局限性还是比较大的，感觉也不太成熟，较容易崩溃。投放到生产环境前需要进行大量的测试覆盖（尤其是新的patch要在测试机上过一遍），且仅仅建议作为紧急用途使用。</em></strong>   </p>
</li>
<li><p>上面编写的工具类对PatchManager 进行了封装。浏览一下源码很容易发现它也仅仅是为com.alipay.euler.andfix.AndFixManager类封装操作一个工具类。  </p>
<p>这个PatchManager 类实际上来说，写的并不太好。一个很简单的多进程APP场景就令PatchManager显得笨拙：它会在addPatch时将你的apatch文件拷贝到app的fileDir内。若多个进程都要更新这个apatch，addPatch方法将会拷贝多次该文件。<br>一个简单的解决方案就是自己重新实现一个PatchManager。移除掉拷贝文件到fileDir的画蛇添足操作，将apatch直接下载到fileDir。为它添加单例/多进程更新广播/网络加载等实用功能。具体不细讲。<br><strong><strong>另外</strong></strong>，AndFix热修复可能直接导致用户的APP Crash掉，并且有可能是每次开启都会Crash，这就很尴尬了。除部署严格测试和发布灰度包以外，还可以考虑在Thread.setDefaultUncaughtExceptionHandler()中处理异常，根据抛出异常的情况自己清空本次更新（或者提示用户手动清除也行）。挽回一点用户体验。</p>
</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>AndFix部署到项目的过程虽有一些坑，总体较为简单。AndFix能火线救急，但是局限性也较大，杀伤力也很大（本来不崩溃的应用可以用AndFix强行弄崩溃了）。在不同Android适配上据说也有不小的坑（未验证过）。两个字：<strong><strong>慎用</strong></strong>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/26/Android热修复框架-AndFix在项目内部署/" data-id="cj0rqkswc0001rk3wjc4sefzr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/热修复/">热修复</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android热修复框架-AndFix的初步接触" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/25/Android热修复框架-AndFix的初步接触/" class="article-date">
  <time datetime="2017-03-25T06:31:05.000Z" itemprop="datePublished">2017-03-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/25/Android热修复框架-AndFix的初步接触/">Android热修复框架: AndFix的初步接触</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p><strong>AndFix</strong> <a href="https://github.com/alibaba/AndFix.git" target="_blank" rel="external">Github: AndFix</a>（当前版本0.5.0）是阿里推出的Android热修复方案。<br>市面上方案较多，选择它是因为它的效果比目前市面上其他的修复方案要好（修复方案比较不是本文重点，本文仅做实践记录）。<br>AndFix方案只能对代码进行热修复实现修复代码bug，而无法热更新资源。</p>
<h2 id="目标：在AndFix提供的Demo中使用AndFix，试验热修复Demo中的方法。"><a href="#目标：在AndFix提供的Demo中使用AndFix，试验热修复Demo中的方法。" class="headerlink" title="目标：在AndFix提供的Demo中使用AndFix，试验热修复Demo中的方法。"></a>目标：在AndFix提供的Demo中使用AndFix，试验热修复Demo中的方法。</h2><h1 id="Demo配置"><a href="#Demo配置" class="headerlink" title="Demo配置"></a>Demo配置</h1><ol>
<li><p>从Github下载AndFix源码。</p>
</li>
<li><p>打开Android Studio 2.3，File-&gt;New-&gt;Import Project导入AndFix项目。</p>
</li>
<li><p>File-&gt;New-&gt;Import Project导入AndFixDemo项目。（在AndFix项目中sample文件夹中）。</p>
</li>
<li><p>AndFixDemo导入完成后，项目应该会报错。因为AndFixDemo中还没有添加AndFix库。</p>
</li>
<li><p>切换到AndFix项目，打开命令行，输入gradle assembleRelease编译AndFix。编译完成后在项目的build/output/aar目录找到andfix-release.aar。</p>
</li>
<li><p>将andfix-release.aar拷贝到AndFixDemo项目内的app/libs文件夹（若没有该文件夹，请新建）。</p>
</li>
<li><p>打开AndFixDemo项目的app/build.gradle文件，添加以下代码，</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">repositories</span> &#123;</div><div class="line">    <span class="keyword">flatDir</span> &#123;</div><div class="line">        dirs <span class="string">'libs'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">    <span class="keyword">compile</span>(name: <span class="string">'andfix-release'</span>, ext: <span class="string">'aar'</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>然后Sync一下项目。</p>
<p>这时候报了个错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Error:Execution failed for task &apos;:app:processDebugManifest&apos;.</div><div class="line">&gt; Manifest merger failed : uses-sdk:minSdkVersion 8 cannot be smaller than version 9 declared in library [:andfix-release:] C:\Users\anonymous\.android\build-cache\5887af3b2772a1bf81b83033920436ff6841c8de\output\AndroidManifest.xml</div><div class="line">	Suggestion: use tools:overrideLibrary=&quot;com.alipay.euler.andfix&quot; to force usage</div></pre></td></tr></table></figure>
<p>把app/build.gradle中 android { defaultConfig { minSdkVersion从8 改为9，重新Sync。 错误消失，项目Demo配置完成。</p>
<h2 id="上面说的是本地编译-amp-添加方法，也可以通过在build-gradle中加入以下代码引入andfix库："><a href="#上面说的是本地编译-amp-添加方法，也可以通过在build-gradle中加入以下代码引入andfix库：" class="headerlink" title="上面说的是本地编译&amp;添加方法，也可以通过在build.gradle中加入以下代码引入andfix库："></a>上面说的是本地编译&amp;添加方法，也可以通过在build.gradle中加入以下代码引入andfix库：</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">	<span class="keyword">compile</span> <span class="string">'com.alipay.euler:andfix:0.5.0@aar'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="热修复使用"><a href="#热修复使用" class="headerlink" title="热修复使用"></a>热修复使用</h1><p>打开Android设备，运行Android Studio编译AndFixDemo安装App并运行。 </p>
<p>App运行后，会执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Log.e(TAG, A.a(<span class="string">"good"</span>));</div><div class="line">Log.e(TAG, <span class="string">""</span> + <span class="keyword">new</span> A().b(<span class="string">"s1"</span>, <span class="string">"s2"</span>));</div><div class="line">Log.e(TAG, <span class="string">""</span> + <span class="keyword">new</span> A().getI());</div></pre></td></tr></table></figure>
<p>相关类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">O</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> String s = <span class="string">"s"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">O</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.s = s;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> s;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">.......</div><div class="line">.......</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> i = <span class="number">10</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> O o = <span class="keyword">new</span> O(<span class="string">"a"</span>);</div><div class="line">    String s = <span class="string">"s"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">a</span><span class="params">(String str)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"euler"</span>, <span class="string">"fix error"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="string">"a"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">b</span><span class="params">(String s1, String s2)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"euler"</span>, <span class="string">"fix error"</span>);</div><div class="line">        Log.i(<span class="string">"euler"</span>, o.s);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getI</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> i;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到log输出为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">03-25 08:07:39.193 20868-20868/com.euler.andfix D/euler: inited.</div><div class="line">03-25 08:07:39.194 20868-20868/com.euler.andfix D/euler: apatch loaded.</div><div class="line">03-25 08:07:39.206 20868-20868/com.euler.andfix I/euler: fix error</div><div class="line">03-25 08:07:39.206 20868-20868/com.euler.andfix E/euler: a</div><div class="line">03-25 08:07:39.206 20868-20868/com.euler.andfix I/euler: fix error</div><div class="line">03-25 08:07:39.206 20868-20868/com.euler.andfix I/euler: a</div><div class="line">03-25 08:07:39.206 20868-20868/com.euler.andfix E/euler: 0</div><div class="line">03-25 08:07:39.206 20868-20868/com.euler.andfix E/euler: 10</div></pre></td></tr></table></figure>
<p><strong><em>现在开始！！！</em></strong><br>目标：尝试修改类A的行为。</p>
<h4 id="1-在AndFix项目根目录找到tools文件夹，解压里面的apkpatch-1-0-3-zip，得到文件夹apkpatch-1-0-3，执行一下apkpatch-bat。"><a href="#1-在AndFix项目根目录找到tools文件夹，解压里面的apkpatch-1-0-3-zip，得到文件夹apkpatch-1-0-3，执行一下apkpatch-bat。" class="headerlink" title="1. 在AndFix项目根目录找到tools文件夹，解压里面的apkpatch-1.0.3.zip，得到文件夹apkpatch-1.0.3，执行一下apkpatch.bat。"></a>1. 在AndFix项目根目录找到tools文件夹，解压里面的apkpatch-1.0.3.zip，得到文件夹apkpatch-1.0.3，执行一下apkpatch.bat。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">X:\apkpatch-1.0.3&gt;apkpatch.bat</div><div class="line">ApkPatch v1.0.3 - a tool for build/merge Android Patch file (.apatch).</div><div class="line">Copyright 2015 supern lee &lt;sanping.li@alipay.com&gt;</div><div class="line"></div><div class="line">usage: apkpatch -f &lt;new&gt; -t &lt;old&gt; -o &lt;output&gt; -k &lt;keystore&gt; -p &lt;***&gt; -a &lt;alias&gt; -e &lt;***&gt;</div><div class="line"> -a,--alias &lt;alias&gt;     alias.</div><div class="line"> -e,--epassword &lt;***&gt;   entry password.</div><div class="line"> -f,--from &lt;loc&gt;        new Apk file path.</div><div class="line"> -k,--keystore &lt;loc&gt;    keystore path.</div><div class="line"> -n,--name &lt;name&gt;       patch name.</div><div class="line"> -o,--out &lt;dir&gt;         output dir.</div><div class="line"> -p,--kpassword &lt;***&gt;   keystore password.</div><div class="line"> -t,--to &lt;loc&gt;          old Apk file path.</div><div class="line"></div><div class="line">usage: apkpatch -m &lt;apatch_path...&gt; -k &lt;keystore&gt; -p &lt;***&gt; -a &lt;alias&gt; -e &lt;***&gt;</div><div class="line"> -a,--alias &lt;alias&gt;     alias.</div><div class="line"> -e,--epassword &lt;***&gt;   entry password.</div><div class="line"> -k,--keystore &lt;loc&gt;    keystore path.</div><div class="line"> -m,--merge &lt;loc...&gt;    path of .apatch files.</div><div class="line"> -n,--name &lt;name&gt;       patch name.</div><div class="line"> -o,--out &lt;dir&gt;         output dir.</div><div class="line"> -p,--kpassword &lt;***&gt;   keystore password.</div><div class="line"></div><div class="line">X:\apkpatch-1.0.3&gt;</div></pre></td></tr></table></figure>
<p>Demo的MainApplication模块实现了载入patch并应用的功能：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"euler"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String APATCH_PATH = <span class="string">"/out.apatch"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * patch manager</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> PatchManager mPatchManager;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        <span class="comment">// initialize</span></div><div class="line">        mPatchManager = <span class="keyword">new</span> PatchManager(<span class="keyword">this</span>);</div><div class="line">        mPatchManager.init(<span class="string">"1.0"</span>);</div><div class="line">        Log.d(TAG, <span class="string">"inited."</span>);</div><div class="line"></div><div class="line">        <span class="comment">// load patch</span></div><div class="line">        mPatchManager.loadPatch();</div><div class="line">        Log.d(TAG, <span class="string">"apatch loaded."</span>);</div><div class="line"></div><div class="line">        <span class="comment">// add patch at runtime</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// .apatch file path</span></div><div class="line">            String patchFileString = Environment.getExternalStorageDirectory()</div><div class="line">                    .getAbsolutePath() + APATCH_PATH;</div><div class="line">            mPatchManager.addPatch(patchFileString);</div><div class="line">            Log.d(TAG, <span class="string">"apatch:"</span> + patchFileString + <span class="string">" added."</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            Log.e(TAG, <span class="string">""</span>, e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>以上代码是AndFix的<strong><em>使用方法！！！</em></strong></p>
<p>apkpatch工具可以为你生成一个patch文件，按照代码中描述，将apkpatch生成的patch文件放到/sdcard/out.apatch目录就可以了。<br>App启动后会将patch载入，并更新app。</p>
<h4 id="2-生成keystore，并为apk签名。"><a href="#2-生成keystore，并为apk签名。" class="headerlink" title="2. 生成keystore，并为apk签名。"></a>2. 生成keystore，并为apk签名。</h4><p>1) 切到AndFixDemo项目，在Android Studio 中点击Build-&gt;Generated Signed Apk， 生成一个keystore命名为key.keystore保存在AndFixDemo项目根目录。<br>我这里密码是123456，alias是key，信息全部是乱写的。</p>
<p>2) 使用Build-&gt;Generated Signed Apk编译出一个apk文件，重命名为old.apk。就放在app目录。</p>
<p>3) 改类A为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> i = <span class="number">20</span>; <span class="comment">//从10修改到20</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> O o = <span class="keyword">new</span> O(<span class="string">"b"</span>); <span class="comment">//从"s" 修改为 "b"</span></div><div class="line">    String s = <span class="string">"s"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">a</span><span class="params">(String str)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"euler"</span>, <span class="string">"fix success"</span>); <span class="comment">//从 "error" 修改为 "success"</span></div><div class="line">        <span class="keyword">return</span> str; <span class="comment">//从"a" 改为 str</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">b</span><span class="params">(String s1, String s2)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"euler"</span>, <span class="string">"fix success"</span>); <span class="comment">//从 "error" 修改为 "success"</span></div><div class="line">        Log.i(<span class="string">"euler"</span>, o.s);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getI</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> i;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>4) 再使用Build-&gt;Generated Signed Apk编译出一个apk文件，重命名为new.apk。就放在app目录。</p>
<p>5) 把<br><figure class="highlight bat"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@<span class="built_in">set</span> /p APK_PATCH=请输入apkpatch.bat路径名：</div><div class="line"><span class="variable">%APK_PATCH%</span> -f app/new.apk -t app/old.apk -o out.apatch -k key.keystore -p <span class="number">123456</span> -a key -e <span class="number">123456</span></div></pre></td></tr></table></figure></p>
<p>存到文件patch.bat，放在AndFixDemo项目根目录。</p>
<p>6) 执行patch.bat<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">X:\project\AndFixDemo&gt;patch</div><div class="line">请输入apkpatch.bat路径名：X:\apkpatch-1.0.3\apkpatch.bat</div><div class="line"></div><div class="line">X:\project\AndFixDemo&gt;X:\apkpatch-1.0.3\apkpatch.bat -f app/new.apk -t app/old.apk -o out.apatch -k key.keystore -p 123456 -a key -e 123456</div><div class="line">add modified Method:Ljava/lang/String;  a(Ljava/lang/String;)  in Class:Lcom/euler/test/A;</div><div class="line">add modified Method:I  b(Ljava/lang/String;Ljava/lang/String;)  in Class:Lcom/euler/test/A;</div><div class="line"></div><div class="line">X:\project\AndFixDemo&gt;</div></pre></td></tr></table></figure></p>
<p>工具告诉我们已经做好两个方法的patch了。<br>这里apkpatch为我们生成了一个文件夹，里面放了几个文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">X:\project\AndFixDemo&gt;dir out.apatch</div><div class="line"> 驱动器 X 中的卷是 SSD</div><div class="line"> 卷的序列号是 A64D-1BE1</div><div class="line"></div><div class="line"> X:\project\AndFixDemo\out.apatch 的目录</div><div class="line"></div><div class="line">2017/03/25  19:54    &lt;DIR&gt;          .</div><div class="line">2017/03/25  19:54    &lt;DIR&gt;          ..</div><div class="line">2017/03/25  19:54             1,316 diff.dex</div><div class="line">2017/03/25  19:54             2,846 new-28ef61a629487761bedf0f2f0c4ac17f.apatch</div><div class="line">2017/03/25  19:54    &lt;DIR&gt;          smali</div><div class="line">               2 个文件          4,162 字节</div><div class="line">               3 个目录 66,200,182,784 可用字节</div><div class="line"></div><div class="line">X:\project\AndFixDemo&gt;</div></pre></td></tr></table></figure>
<p>其中new-28ef61a629487761bedf0f2f0c4ac17f.apatch这个文件就是起作用的。</p>
<p>我们先安装old.apk，然后运行。 日志如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">03-25 08:07:39.193 20868-20868/com.euler.andfix D/euler: inited.</div><div class="line">03-25 08:07:39.194 20868-20868/com.euler.andfix D/euler: apatch loaded.</div><div class="line">03-25 08:07:39.206 20868-20868/com.euler.andfix I/euler: fix error</div><div class="line">03-25 08:07:39.206 20868-20868/com.euler.andfix E/euler: a</div><div class="line">03-25 08:07:39.206 20868-20868/com.euler.andfix I/euler: fix error</div><div class="line">03-25 08:07:39.206 20868-20868/com.euler.andfix I/euler: a</div><div class="line">03-25 08:07:39.206 20868-20868/com.euler.andfix E/euler: 0</div><div class="line">03-25 08:07:39.206 20868-20868/com.euler.andfix E/euler: 10</div></pre></td></tr></table></figure></p>
<p>他现在是这么个提示。</p>
<p>我们把new-28ef61a629487761bedf0f2f0c4ac17f.apatch上传到手机的/sdcard/out.apatch路径里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">X:\project\AndFixDemo&gt;adb push out.apatch\new-28ef61a629487761bedf0f2f0c4ac17f.apatch /sdcard/out.apatch</div><div class="line">[100%] /sdcard/out.apatch</div><div class="line"></div><div class="line">X:\project\AndFixDemo&gt;</div></pre></td></tr></table></figure>
<p>然后再开app，发现log变了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">03-25 08:14:54.119 27167-27167/com.euler.andfix D/euler: inited.</div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: modify com.euler.test.A.s flag:</div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: setFieldFlag_5_1: 1 </div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: modify com.euler.test.A.i flag:</div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: setFieldFlag_5_1: 9 </div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: modify com.euler.test.A.o flag:</div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: setFieldFlag_5_1: 9 </div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: replace_5_1: -1354706580 , -1354706580</div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: modify com.euler.test.A_CF.s flag:</div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: setFieldFlag_5_1: 1 </div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: modify com.euler.test.A_CF.i flag:</div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: setFieldFlag_5_1: 9 </div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: modify com.euler.test.A_CF.o flag:</div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: setFieldFlag_5_1: 9 </div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: replace_5_1: 1927159936 , 1927159936</div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: modify com.euler.test.A_CF.s flag:</div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: setFieldFlag_5_1: 1 </div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: modify com.euler.test.A_CF.i flag:</div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: setFieldFlag_5_1: 9 </div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: modify com.euler.test.A_CF.o flag:</div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/AndFix: setFieldFlag_5_1: 9 </div><div class="line">03-25 08:14:54.128 27167-27167/com.euler.andfix D/euler: apatch loaded.</div><div class="line">03-25 08:14:54.139 27167-27167/com.euler.andfix I/euler: fix success</div><div class="line">03-25 08:14:54.139 27167-27167/com.euler.andfix E/euler: good</div><div class="line">03-25 08:14:54.139 27167-27167/com.euler.andfix I/euler: fix success</div><div class="line">03-25 08:14:54.139 27167-27167/com.euler.andfix I/euler: a</div><div class="line">03-25 08:14:54.139 27167-27167/com.euler.andfix E/euler: 0</div><div class="line">03-25 08:14:54.139 27167-27167/com.euler.andfix E/euler: 10</div></pre></td></tr></table></figure></p>
<p>可以看到里面的两个方法调用的确修改成功了，但是改动的两个静态变量的影响没有到andFix里面。  </p>
<p>通过观察日志可以做出猜测：里面有两个replace，应该代表修改了两个方法名字。</p>
<p>用命令把/sdcard/out.apatch给删掉，发现log依旧是修复过的。框架应该已经把修改应用到app里了。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>AndFix项目提供了一个Demo，Demo已经实现了patch的代码流程。<br>本文的实验修改了Demo中的类，并用工具通过比较新老app生成更新patch。<br>可以看到AndFix框架读取到更新patch后成功的修复了类内的一个类方法和对象方法，而对类变量修改却无效。<br>若在项目内部署了这样一个热更新框架，的确能够实现远程无声修bug。</p>
<h2 id="若想应用AndFix到生产环境，还需要"><a href="#若想应用AndFix到生产环境，还需要" class="headerlink" title="若想应用AndFix到生产环境，还需要"></a>若想应用AndFix到生产环境，还需要</h2><p>1) 大概了解内部原理机制<br>2) 编写测试代码测试它的修改生效范围<br>3) MultiDex对它的影响<br>4) 代码混淆</p>
<h2 id="不过这篇文章的目标已经达成了。"><a href="#不过这篇文章的目标已经达成了。" class="headerlink" title="不过这篇文章的目标已经达成了。"></a>不过这篇文章的目标已经达成了。</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/25/Android热修复框架-AndFix的初步接触/" data-id="cj0rqkswi0003rk3w46tyfrsn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/热修复/">热修复</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Java语言的新特性" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/09/Java语言的新特性/" class="article-date">
  <time datetime="2016-12-09T02:30:34.000Z" itemprop="datePublished">2016-12-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/09/Java语言的新特性/">Java语言的新特性</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>从<a href="https://docs.oracle.com/javase/8/docs/technotes/guides/language/enhancements.html" target="_blank" rel="external">官方文档</a>上学习了一下从Java5到Java8各个版本的语言新特性, 在此总结.</p>
<h2 id="Java8"><a href="#Java8" class="headerlink" title="Java8"></a>Java8</h2><h3 id="lambda表达式"><a href="#lambda表达式" class="headerlink" title="*lambda表达式"></a><a href="http://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html" target="_blank" rel="external">*lambda表达式</a></h3><p>可以把一个<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/FunctionalInterface.html" target="_blank" rel="external">函数式接口</a>写作lambda表达式<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//常规写法</span></div><div class="line"><span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//do sth</span></div><div class="line">  &#125;</div><div class="line">&#125;).start();</div><div class="line"></div><div class="line"><span class="comment">//lambda表达式写法</span></div><div class="line"><span class="keyword">new</span> Thread(()-&gt;&#123;<span class="comment">/*do sth*/</span>&#125;).start();</div></pre></td></tr></table></figure></p>
<p>lambda表达式也支持以下特性</p>
<ul>
<li><p><a href="http://docs.oracle.com/javase/tutorial/java/javaOO/methodreferences.html" target="_blank" rel="external">方法引用</a>: 已有名称的方法可以用紧凑的,容易阅读的lambda表达式来表现  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</div><div class="line">	......</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">compareByAge</span><span class="params">(Person a, Person b)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> a.birthday.compareTo(b.birthday);</div><div class="line">    &#125;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Person[] rosterAsArray = roster.toArray(<span class="keyword">new</span> Person[roster.size()]);</div><div class="line"></div><div class="line"><span class="comment">//常规写法        </span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonAgeComparator</span> <span class="keyword">implements</span> <span class="title">Comparator</span>&lt;<span class="title">Person</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Person a, Person b)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> a.getBirthday().compareTo(b.getBirthday());</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">Arrays.sort(rosterAsArray, <span class="keyword">new</span> PersonAgeComparator());</div><div class="line"></div><div class="line"><span class="comment">//lambda表达式写法</span></div><div class="line">Arrays.sort(rosterAsArray,</div><div class="line">    (Person a, Person b) -&gt; &#123;</div><div class="line">        <span class="keyword">return</span> a.getBirthday().compareTo(b.getBirthday());</div><div class="line">    &#125;</div><div class="line">);</div><div class="line"></div><div class="line"><span class="comment">//lambda表达式写法</span></div><div class="line">Arrays.sort(rosterAsArray,</div><div class="line">    (a, b) -&gt; Person.compareByAge(a, b)</div><div class="line">);</div><div class="line"></div><div class="line"><span class="comment">//方法引用写法</span></div><div class="line">Arrays.sort(rosterAsArray, Person::compareByAge);</div></pre></td></tr></table></figure>
</li>
<li><p><a href="http://docs.oracle.com/javase/tutorial/java/IandI/defaultmethods.html" target="_blank" rel="external">默认方法</a>: 可以在interface内添加使用default关键字修饰的具有实现的方法, 它和旧版本的interface是兼容的;<br>并且可以在interface中定义静态(static)方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">I</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">a</span><span class="params">()</span></span>;</div><div class="line">  <span class="comment">//静态方法</span></div><div class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">b</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//do sth</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">//默认方法</span></div><div class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">c</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//do sth</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/language/lambda_api_jdk8.html" target="_blank" rel="external">新api的增强</a>: 加入一些支持lambda表达式的包如<a href="http://docs.oracle.com/javase/8/docs/api/java/util/function/package-summary.html" target="_blank" rel="external">java.util.function</a>, <a href="http://docs.oracle.com/javase/8/docs/api/java/util/stream/package-summary.html" target="_blank" rel="external">java.util.stream</a>.<br>另外在<a href="http://docs.oracle.com/javase/8/docs/api/java/util/Collection.html" target="_blank" rel="external">java.util.Collection</a>接口中增加了一个default方法 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">default</span> Stream&lt;E&gt; <span class="title">stream</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>为集合提供流操作</p>
<h3 id="改进的类型推断"><a href="#改进的类型推断" class="headerlink" title="*改进的类型推断"></a>*改进的<a href="http://docs.oracle.com/javase/tutorial/java/generics/genTypeInference.html" target="_blank" rel="external">类型推断</a></h3><p>现在类型推断可以通过目标类型推断出泛型方法调用的类型参数. Java7可以对赋值语句使用类型推断, 而在Java8中会对更多的上下文中的目标类型进行类型推断.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">List&lt;String&gt; stringList = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">//Java7特性: 对泛型实例创建进行类型推断</span></div><div class="line">stringList.add(<span class="string">"A"</span>);</div><div class="line">stringList.addAll(Arrays.asList());  <span class="comment">//Java8 特性: 可以从方法参数的类型参数来进行类型推断</span></div></pre></td></tr></table></figure>
<h3 id="类型注解"><a href="#类型注解" class="headerlink" title="*类型注解"></a><a href="http://docs.oracle.com/javase/tutorial/java/annotations/basics.html" target="_blank" rel="external">*类型注解</a></h3><p>现在可以在任何使用类型的地方应用注解<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@NonNull</span> String str;</div><div class="line"><span class="comment">//实例创建</span></div><div class="line"><span class="keyword">new</span> <span class="meta">@Interned</span> MyObject();</div><div class="line"><span class="comment">//类型转换</span></div><div class="line">myString = (<span class="meta">@NonNull</span> String) str;</div><div class="line"><span class="comment">//接口实现</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnmodifiableList</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span></span></div><div class="line">       @<span class="title">Readonly</span> <span class="title">List</span>&lt;@<span class="title">Readonly</span> <span class="title">T</span>&gt; &#123; ... &#125;</div><div class="line"><span class="comment">//异常声明</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">monitorTemperature</span><span class="params">()</span> <span class="keyword">throws</span></span></div><div class="line">       @Critical TemperatureException &#123; ... &#125;</div></pre></td></tr></table></figure></p>
<h3 id="重复注解"><a href="#重复注解" class="headerlink" title="*重复注解"></a><a href="http://docs.oracle.com/javase/tutorial/java/annotations/repeating.html" target="_blank" rel="external">*重复注解</a></h3><p>可以在一个类型定义上重复的使用多次注解(加入了@Repeatable注解类型)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Schedules &#123;</div><div class="line">    Schedule[] value();</div><div class="line">&#125;</div><div class="line">....</div><div class="line"><span class="meta">@Repeatable</span>(Schedules.class)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Schedule &#123;</div><div class="line">  <span class="function">String <span class="title">dayOfMonth</span><span class="params">()</span> <span class="keyword">default</span> "first"</span>;</div><div class="line">  <span class="function">String <span class="title">dayOfWeek</span><span class="params">()</span> <span class="keyword">default</span> "Mon"</span>;</div><div class="line">  <span class="function"><span class="keyword">int</span> <span class="title">hour</span><span class="params">()</span> <span class="keyword">default</span> 12</span>;</div><div class="line">&#125;</div><div class="line">...</div><div class="line"><span class="meta">@Schedule</span>(dayOfMonth=<span class="string">"last"</span>)</div><div class="line"><span class="meta">@Schedule</span>(dayOfWeek=<span class="string">"Fri"</span>, hour=<span class="string">"23"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPeriodicCleanup</span><span class="params">()</span> </span>&#123; ... &#125;</div></pre></td></tr></table></figure></p>
<h3 id="方法参数反射"><a href="#方法参数反射" class="headerlink" title="*方法参数反射"></a><a href="http://docs.oracle.com/javase/tutorial/reflect/member/methodparameterreflection.html" target="_blank" rel="external">*方法参数反射</a></h3><p>现在可以使用<a href="http://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Executable.html#getParameters" target="_blank" rel="external">java.lang.reflect.Executable.getParameters</a>得到<a href="http://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Constructor.html" target="_blank" rel="external">构造器</a>,和<a href="http://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Method.html" target="_blank" rel="external">方法</a>的参数表<br>(Executable是构造器和方法的父类)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Method method = ...;</div><div class="line">method.getParameters();</div><div class="line"></div><div class="line">Constructor constructor = ...;</div><div class="line">constructor.getParameters();</div></pre></td></tr></table></figure>
<h2 id="Java7"><a href="#Java7" class="headerlink" title="Java7"></a>Java7</h2><h3 id="二进制字面常量"><a href="#二进制字面常量" class="headerlink" title="*二进制字面常量"></a><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/language/binary-literals.html" target="_blank" rel="external">*二进制字面常量</a></h3><p>可以使用二进制字面常量来表达整形类型(byte, short, int, long), 以0b(0B)作为前缀<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">System.out.println(<span class="number">0b11</span>); <span class="comment">// 3</span></div><div class="line">System.out.println(<span class="number">0B111</span>); <span class="comment">// 7</span></div></pre></td></tr></table></figure></p>
<h3 id="字面常量数字的下划线"><a href="#字面常量数字的下划线" class="headerlink" title="*字面常量数字的下划线"></a><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/language/underscores-literals.html" target="_blank" rel="external">*字面常量数字的下划线</a></h3><p>在数字常量中可以使用下划线来提高数字的可读性, 不能将下划线添加在数字头尾部<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">System.out.println(<span class="number">11_1</span>); <span class="comment">// 111</span></div><div class="line">System.out.println(<span class="number">011_1</span>); <span class="comment">// 73</span></div><div class="line">System.out.println(<span class="number">0x11_1</span>); <span class="comment">// 273</span></div><div class="line">System.out.println(<span class="number">0B11_1</span>); <span class="comment">// 7</span></div></pre></td></tr></table></figure></p>
<h3 id="String类可以用于switch语句"><a href="#String类可以用于switch语句" class="headerlink" title="*String类可以用于switch语句"></a><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/language/strings-switch.html" target="_blank" rel="external">*String类可以用于switch语句</a></h3><p>这里case语句中的statement只能使用常量字符串<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">String str = <span class="keyword">new</span> String(<span class="string">"aaa"</span>);</div><div class="line"><span class="keyword">switch</span> (str) &#123;</div><div class="line">    <span class="keyword">case</span> <span class="string">"aaa"</span>:</div><div class="line">        System.out.println(<span class="keyword">true</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> <span class="string">"bbb"</span>:</div><div class="line">        System.out.println(<span class="keyword">false</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="泛型实例创建的类型推断"><a href="#泛型实例创建的类型推断" class="headerlink" title="*泛型实例创建的类型推断"></a><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/language/type-inference-generic-instance-creation.html" target="_blank" rel="external">*泛型实例创建的类型推断</a></h3><p>只要编译器可以根据上下文推断出泛型实例的类型参数, 在调用泛型类型的构造器时可以用&lt;&gt;(学名叫做菱形”diamond”)来替代指定类型参数.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">List&lt;Integer&gt; integerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div></pre></td></tr></table></figure></p>
<h3 id="优化变长参数的方法调用"><a href="#优化变长参数的方法调用" class="headerlink" title="*优化变长参数的方法调用"></a><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/language/non-reifiable-varargs.html" target="_blank" rel="external">*优化变长参数的方法调用</a></h3><p>在变长参数中使用不可具体化的类型(例如List<string>)时, 编译器会报出警告, 该警告可以被<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SafeVarargs</span></div></pre></td></tr></table></figure></string></p>
<p>和<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"varargs"</span>&#125;)</div></pre></td></tr></table></figure></p>
<p>抑制.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//Main.java</span></div><div class="line">...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        List&lt;String&gt; a = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">        fun(a, a);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">fun</span><span class="params">(T... args)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (T t : args) &#123;</div><div class="line">            System.out.println(t);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> args[<span class="number">0</span>];</div><div class="line">    &#125;</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>使用java6 编译Main.java 加上 -Xlint:unchecked参数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">jdk1.6.0_45\bin\javac.exe -Xlint:unchecked Main.java</div><div class="line">Main.java:38: 警告：[unchecked] 对于 varargs 参数，类型 java.util.List&lt;java.lang.String&gt;[] 的泛型数组创建未经检查</div><div class="line">        fun(a, a);</div><div class="line">           ^</div><div class="line">1 警告</div></pre></td></tr></table></figure></p>
<p>使用java7 编译Main.java 加上 -Xlint:unchecked参数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">jdk1.7.0_80\bin\javac.exe -Xlint:unchecked Main.java</div><div class="line">Main.java:32: 警告: [unchecked] 对于类型为List&lt;String&gt;[]的 varargs 参数, 泛型数组创建未经过检查</div><div class="line">        fun(a, a);</div><div class="line">           ^</div><div class="line">Main.java:35: 警告: [unchecked] 参数化 vararg 类型T的堆可能已受污染</div><div class="line">    public static &lt;T&gt; T fun(T... args) &#123;</div><div class="line">                                 ^</div><div class="line">  其中, T是类型变量:</div><div class="line">    T扩展已在方法 &lt;T&gt;fun(T...)中声明的Object</div><div class="line">2 个警告</div></pre></td></tr></table></figure></p>
<p>添加 @SafeVarargs<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SafeVarargs</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">fun</span><span class="params">(T... args)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (T t : args) &#123;</div><div class="line">        System.out.println(t);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> args[<span class="number">0</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编译器警告消失</p>
<p>添加 @SuppressWarnings({“unchecked”, “varargs”}),<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">jdk1.7.0_80\bin\javac.exe -Xlint:unchecked Main.java</div><div class="line">Main.java:32: 警告: [unchecked] 对于类型为List&lt;String&gt;[]的 varargs 参数, 泛型数组创建未经过检查</div><div class="line">        fun(a, a);</div><div class="line">           ^</div><div class="line">1 个警告</div></pre></td></tr></table></figure></p>
<h3 id="try-with-resource"><a href="#try-with-resource" class="headerlink" title="*try_with_resource"></a><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/language/try-with-resources.html" target="_blank" rel="external">*try_with_resource</a></h3><p>使用try_with_resource语句, 可以对实现了AutoCloseable(java7 加入的接口, 原有的Closeable成为它的子类) 的资源进行自动关闭, 而不用手动在finally语句块中关闭.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//常规写法</span></div><div class="line"><span class="function"><span class="keyword">static</span> String <span class="title">readFirstLineFromFileWithFinallyBlock</span><span class="params">(String path)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(path));</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">return</span> br.readLine();</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">    <span class="keyword">if</span> (br != <span class="keyword">null</span>) br.close();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//try_with_resource</span></div><div class="line"><span class="function"><span class="keyword">static</span> String <span class="title">readFirstLineFromFile</span><span class="params">(String path)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  <span class="keyword">try</span> (BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(path))) &#123;</div><div class="line">    <span class="keyword">return</span> br.readLine();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//try_with_resource</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeToFileZipFileContents</span><span class="params">(String zipFileName, String outputFileName)</span></span></div><div class="line">        <span class="keyword">throws</span> java.io.IOException &#123;</div><div class="line"></div><div class="line">    java.nio.charset.Charset charset = java.nio.charset.StandardCharsets.US_ASCII;</div><div class="line">    java.nio.file.Path outputFilePath = java.nio.file.Paths.get(outputFileName);</div><div class="line"></div><div class="line">    <span class="comment">// Open zip file and create output file with try-with-resources statement</span></div><div class="line"></div><div class="line">    <span class="keyword">try</span> (</div><div class="line">            java.util.zip.ZipFile zf = <span class="keyword">new</span> java.util.zip.ZipFile(zipFileName);</div><div class="line">            java.io.BufferedWriter writer = java.nio.file.Files.newBufferedWriter(outputFilePath, charset)</div><div class="line">    ) &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Enumerate each entry</span></div><div class="line"></div><div class="line">        <span class="keyword">for</span> (java.util.Enumeration entries = zf.entries(); entries.hasMoreElements(); ) &#123;</div><div class="line"></div><div class="line">            <span class="comment">// Get the entry name and write it to the output file</span></div><div class="line"></div><div class="line">            String newLine = System.getProperty(<span class="string">"line.separator"</span>);</div><div class="line">            String zipEntryName = ((java.util.zip.ZipEntry) entries.nextElement()).getName() + newLine;</div><div class="line">            writer.write(zipEntryName, <span class="number">0</span>, zipEntryName.length());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里需要注意的是: </p>
<ul>
<li>若try语句块抛出异常, 则在try_with_resource关闭资源调用AutoCloseable.close()时抛出的IOException会被抑制, catch到的异常将是try语句块抛出的异常. 这里可以调用Throwable.getSuppressed()获取被抑制的异常. </li>
<li>在使用finally语句块中关闭资源时, 若try语句块抛出了异常, 则在finally语句块中抛出的IOException异常会覆盖掉try语句块中抛出的异常.</li>
<li>Closeable 是java5加入的关闭资源的方法, 多次调用Closeable.close()关闭资源不会引发错误</li>
<li>AutoCloseable 是java7加入的关闭资源的方法, 仅允许调用一次AutoCloseable.close();</li>
</ul>
<h3 id="多重异常捕获-amp-优化对重抛出异常的类型检查"><a href="#多重异常捕获-amp-优化对重抛出异常的类型检查" class="headerlink" title="* 多重异常捕获&amp;优化对重抛出异常的类型检查"></a><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/language/catch-multiple.html" target="_blank" rel="external">* 多重异常捕获&amp;优化对重抛出异常的类型检查</a></h3><p>多重异常捕获<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//之前的写法</span></div><div class="line"><span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">     logger.log(ex);</div><div class="line">     <span class="keyword">throw</span> ex;</div><div class="line">&#125; <span class="keyword">catch</span> (SQLException ex) &#123;</div><div class="line">     logger.log(ex);</div><div class="line">     <span class="keyword">throw</span> ex;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//现在可以这样写</span></div><div class="line"><span class="keyword">catch</span> (IOException|SQLException ex) &#123;</div><div class="line">    logger.log(ex);</div><div class="line">    <span class="keyword">throw</span> ex;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>重抛出更精确描述的异常, 在java7之前的版本不允许这样写<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rethrowException</span><span class="params">(String exceptionName)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException, NullPointerException &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        <span class="comment">//在这里重抛出类型只能为IOException, NullPointerException, </span></div><div class="line">        <span class="comment">//若有其他类型, 必须在throw子句中声明</span></div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Java6"><a href="#Java6" class="headerlink" title="Java6"></a>Java6</h2><p>java6 在语言方面没有改动, 主要改动在新增了一些包之类的.</p>
<h2 id="Java5"><a href="#Java5" class="headerlink" title="Java5"></a>Java5</h2><h3 id="泛型"><a href="#泛型" class="headerlink" title="*泛型"></a><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/language/generics.html" target="_blank" rel="external">*泛型</a></h3><p>这种期待已久的对类型系统的增强允许类型或方法对各种类型的对象进行操作，同时提供编译时类型的安全性。它将编译器类型安全添加到集合框架中, 消除了类型转换的苦差事.<br>Java中的泛型和C++的模板看上去很相似, 但这相似性是肤浅的: Java的泛型的实现机制是类型擦除, 并不支持泛型对象实例化以及模板元编程.</p>
<p>Java5之前的集合操作写法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Removes 4-letter words from c. Elements must be strings</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">expurgate</span><span class="params">(Collection c)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (Iterator i = c.iterator(); i.hasNext(); )</div><div class="line">      <span class="keyword">if</span> (((String) i.next()).length() == <span class="number">4</span>)</div><div class="line">        i.remove();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>使用泛型的集合操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Removes the 4-letter words from c</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">expurgate</span><span class="params">(Collection&lt;String&gt; c)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (Iterator&lt;String&gt; i = c.iterator(); i.hasNext(); )</div><div class="line">      <span class="keyword">if</span> (i.next().length() == <span class="number">4</span>)</div><div class="line">        i.remove();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>更多的泛型方面资料需参考官方文档和书籍学习.</p>
<h3 id="For-each"><a href="#For-each" class="headerlink" title="*For-each"></a><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/language/foreach.html" target="_blank" rel="external">*For-each</a></h3><p>这个循环的新特性能让你更方便的迭代遍历数组和集合<br>Java5之前的写法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">cancelAll</span><span class="params">(Collection&lt;TimerTask&gt; c)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (Iterator&lt;TimerTask&gt; i = c.iterator(); i.hasNext(); )</div><div class="line">        i.next().cancel();</div><div class="line">&#125;</div><div class="line"><span class="keyword">for</span> (Iterator i = suits.iterator(); i.hasNext(); ) &#123;</div><div class="line">    Suit suit = (Suit) i.next();</div><div class="line">    <span class="keyword">for</span> (Iterator j = ranks.iterator(); j.hasNext(); )</div><div class="line">        sortedDeck.add(<span class="keyword">new</span> Card(suit, j.next()));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ForEach写法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">cancelAll</span><span class="params">(Collection&lt;TimerTask&gt; c)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (TimerTask t : c)</div><div class="line">        t.cancel();</div><div class="line">&#125;</div><div class="line"><span class="keyword">for</span> (Suit suit : suits)</div><div class="line">    <span class="keyword">for</span> (Rank rank : ranks)</div><div class="line">        sortedDeck.add(<span class="keyword">new</span> Card(suit, rank));</div></pre></td></tr></table></figure></p>
<p>数组的ForEach操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span>[] a)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i : a)</div><div class="line">        result += i;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="自动装箱-拆箱"><a href="#自动装箱-拆箱" class="headerlink" title="*自动装箱/拆箱"></a><a href="https://docs.oracle.com/javase/tutorial/java/data/autoboxing.html" target="_blank" rel="external">*自动装箱/拆箱</a></h3><p>Java5会在需要的时候自动在基本类型和相应的包装类型之间进行转换</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">List&lt;Integer&gt; li = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">50</span>; i += <span class="number">2</span>)</div><div class="line">    li.add(i);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">sumEven</span><span class="params">(List&lt;Integer&gt; li)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (Integer i: li)</div><div class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>)</div><div class="line">            sum += i;</div><div class="line">        <span class="keyword">return</span> sum;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其实是<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">List&lt;Integer&gt; li = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">50</span>; i += <span class="number">2</span>)</div><div class="line">    li.add(Integer.valueOf(i));</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">sumEven</span><span class="params">(List&lt;Integer&gt; li)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (Integer i : li)</div><div class="line">        <span class="keyword">if</span> (i.intValue() % <span class="number">2</span> == <span class="number">0</span>)</div><div class="line">            sum += i.intValue();</div><div class="line">        <span class="keyword">return</span> sum;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个转换过程被编译器自动完成了</p>
<h3 id="类型安全枚举"><a href="#类型安全枚举" class="headerlink" title="*类型安全枚举"></a><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/language/enums.html" target="_blank" rel="external">*类型安全枚举</a></h3><p>在java的以往版本中实现枚举模式通常使用整形常数, 这会带来很多问题:</p>
<ul>
<li>类型不安全: 它可以当做数字使用</li>
<li>无名字空间: 必须在名字上添加前缀以同其他枚举区分</li>
<li>较脆弱: 如果改变了枚举的顺序或者增加新的枚举, 就需要重新编译所有代码以保证不会出现未定义行为</li>
<li>不直观: 输出枚举值的Log打印出来的仅仅只是int, 不能直观的表达任何信息</li>
</ul>
<p>新增的关键字enum可以定义一个无法被实例化和继承(final)的类, 在这个类里可以定义一系列作为枚举值的常量供用户使用. 类型安全枚举的好处:</p>
<ul>
<li>枚举常量是枚举类的实例, 他是类型安全且不会和其他枚举类型发生冲突的. </li>
<li>增加了新的枚举常量也不会影响到原有代码的正常工作</li>
<li>枚举常量使用toString()可以输出直接常量字面值, 更加直观.</li>
<li>用户可以在枚举类中定义一些枚举变量可以使用的方法, 让程序逻辑更加清晰.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Operation &#123;</div><div class="line">  PLUS   &#123; <span class="function"><span class="keyword">double</span> <span class="title">eval</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123; <span class="keyword">return</span> x + y; &#125; &#125;,</div><div class="line">  MINUS  &#123; <span class="function"><span class="keyword">double</span> <span class="title">eval</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123; <span class="keyword">return</span> x - y; &#125; &#125;,</div><div class="line">  TIMES  &#123; <span class="function"><span class="keyword">double</span> <span class="title">eval</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123; <span class="keyword">return</span> x * y; &#125; &#125;,</div><div class="line">  DIVIDE &#123; <span class="function"><span class="keyword">double</span> <span class="title">eval</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123; <span class="keyword">return</span> x / y; &#125; &#125;;</div><div class="line"></div><div class="line">  <span class="comment">// Do arithmetic op represented by this constant</span></div><div class="line">  <span class="function"><span class="keyword">abstract</span> <span class="keyword">double</span> <span class="title">eval</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</div><div class="line">    <span class="keyword">double</span> x = Double.parseDouble(args[<span class="number">0</span>]);</div><div class="line">    <span class="keyword">double</span> y = Double.parseDouble(args[<span class="number">1</span>]);</div><div class="line">    <span class="keyword">for</span> (Operation op : Operation.values())</div><div class="line">        System.out.printf(<span class="string">"%f %s %f = %f%n"</span>, x, op, y, op.eval(x, y));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">$ java Operation 4 2</div><div class="line">4.000000 PLUS 2.000000 = 6.000000</div><div class="line">4.000000 MINUS 2.000000 = 2.000000</div><div class="line">4.000000 TIMES 2.000000 = 8.000000</div><div class="line">4.000000 DIVIDE 2.000000 = 2.000000</div></pre></td></tr></table></figure>
<p>在Effective Java的第21条提到用类代替enum结构, 其内容讲的就是实现一种”类型安全枚举”的模型, 用这种更安全的枚举模型来替代原有的类C语言的枚举.而Java5直接在语言层面实现了这种类型安全的枚举模型.在没有极其苛刻的性能要求的情况下(如果你的JVM不是运行在蜂窝电话或者烤面包机上),类型安全枚举带来的额外开销(装载枚举类以及构造常量对象)不会引起用户注意.</p>
<h3 id="变长参数"><a href="#变长参数" class="headerlink" title="*变长参数"></a><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/language/varargs.html" target="_blank" rel="external">*变长参数</a></h3><p>方法调用的最后一个参数允许使用变长参数, 消除了用户手动创建数组打包参数传入方法的痛苦.</p>
<p>Java5以前想要格式化字符串只能这样写<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Object[] arguments = &#123;</div><div class="line">    <span class="keyword">new</span> Integer(<span class="number">7</span>),</div><div class="line">    <span class="keyword">new</span> Date(),</div><div class="line">    <span class="string">"a disturbance in the Force"</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line">String result = MessageFormat.format(</div><div class="line">    <span class="string">"At &#123;1,time&#125; on &#123;1,date&#125;, there was &#123;2&#125; on planet "</span></div><div class="line">     + <span class="string">"&#123;0,number,integer&#125;."</span>, arguments);</div></pre></td></tr></table></figure></p>
<p>而现在<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">String result = MessageFormat.format(</div><div class="line">    <span class="string">"At &#123;1,time&#125; on &#123;1,date&#125;, there was &#123;2&#125; on planet "</span></div><div class="line">    + <span class="string">"&#123;0,number,integer&#125;."</span>,</div><div class="line">    <span class="number">7</span>, <span class="keyword">new</span> Date(), <span class="string">"a disturbance in the Force"</span>);</div></pre></td></tr></table></figure></p>
<p>在Java5里String类基于变长参数的特性提供了新的api, format(). 如果阅读一下源码会发现它直接调用MessageFormat.format()做格式串生成.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">format</span><span class="params">(String pattern,</span></span></div><div class="line">                                Object... arguments);</div></pre></td></tr></table></figure></p>
<h3 id="静态导入"><a href="#静态导入" class="headerlink" title="*静态导入"></a><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/language/static-import.html" target="_blank" rel="external">*静态导入</a></h3><p>导入类内所有静态成员到当前名字空间, 不需要添加类前缀即可引用被导入的静态成员. 官方建议谨慎和适当的使用静态导入以免污染名字空间以及破坏程序的可读性和可维护性.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">double</span> r = Math.cos(Math.PI * theta);</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.Math.*;</div><div class="line"><span class="keyword">double</span> r = cos(PI * theta);</div></pre></td></tr></table></figure>
<h3 id="注解"><a href="#注解" class="headerlink" title="*注解"></a><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/language/annotations.html" target="_blank" rel="external">*注解</a></h3><p>这个新特性可以让程序员在代码中使用声明式编程: 在代码中添加注解, 用工具从注解中生成代码. 这种特性可以极大的减少程序员的工作量. 参考库ButterKnife. 此外程序本身也可以通过反射获取属性和方法的注解信息.<br>定义注解以及使用:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RequestForEnhancement &#123;</div><div class="line">    <span class="function"><span class="keyword">int</span>    <span class="title">id</span><span class="params">()</span></span>;</div><div class="line">    <span class="function">String <span class="title">synopsis</span><span class="params">()</span></span>;</div><div class="line">    <span class="function">String <span class="title">engineer</span><span class="params">()</span> <span class="keyword">default</span> "[unassigned]"</span>; </div><div class="line">    <span class="function">String <span class="title">date</span><span class="params">()</span>    <span class="keyword">default</span> "[unimplemented]"</span>; </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@RequestForEnhancement</span>(</div><div class="line">    id       = <span class="number">2868724</span>,</div><div class="line">    synopsis = <span class="string">"Enable time-travel"</span>,</div><div class="line">    engineer = <span class="string">"Mr. Peabody"</span>,</div><div class="line">    date     = <span class="string">"4/1/3007"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">travelThroughTime</span><span class="params">(Date destination)</span> </span>&#123; ... &#125;</div></pre></td></tr></table></figure></p>
<p>更多的注解方面资料需参考官方文档和书籍学习.</p>
<hr>
<p>感想: Java5之前的Java程序员真辛苦</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/09/Java语言的新特性/" data-id="cj0rqkswk0004rk3w5ti2p60f" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/增量更新/">增量更新</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/热修复/">热修复</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 16.67px;">Android</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/增量更新/" style="font-size: 10px;">增量更新</a> <a href="/tags/热修复/" style="font-size: 13.33px;">热修复</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/03/27/Android应用的增量更新/">Android应用的增量更新</a>
          </li>
        
          <li>
            <a href="/2017/03/27/hello-world/">Hexo 使用说明</a>
          </li>
        
          <li>
            <a href="/2017/03/26/Android热修复框架-AndFix在项目内部署/">Android热修复框架: AndFix在项目内部署</a>
          </li>
        
          <li>
            <a href="/2017/03/25/Android热修复框架-AndFix的初步接触/">Android热修复框架: AndFix的初步接触</a>
          </li>
        
          <li>
            <a href="/2016/12/09/Java语言的新特性/">Java语言的新特性</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 jiang zemin<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>